PSODOSU2 ;BIR/RTR - Dose Check Utility routine continued ;11/18/08
 ;;7.0;OUTPATIENT PHARMACY;**251,375**;DEC 1997;Build 17
 ;
DOSE ;
 S PSODSEQ="" F  S PSODSEQ=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ)) Q:PSODSEQ=""  S PSODLNN1="" F  S PSODLNN1=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1)) Q:PSODLNN1=""  S PSODLECT=0 D
 .F PSODLERA=0:0 S PSODLERA=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"ERROR",PSODLERA)) Q:'PSODLERA  S PSODLECT=PSODLECT+1 D
 ..F PSODLERX="MSG","TEXT" S PSODLERB=$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"ERROR",PSODLERA,PSODLERX)) D
 ...S PSODLERZ=0 Q:PSODLERB=""  D HD I PSODLERF,PSODLERX="MSG" W:'PSODLQT ! D HD
 ...I 'PSODLERF W:'PSODLQT !
 ...S PSODLERF=1 D HD I PSODLERZ W:'PSODLQT !
 ...S PSODLERR=1 D HD W:'PSODLQT&(PSODLECT>1) ! N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF
 ...D HD S PSOCPXG=$P(PSODLNN1,";",4) I '$G(PSOCPXRR(PSOCPXG))&(PSOCPXB>1) D SUB^PSODOSUT W:'PSODLQT&('PSODLERZ) !
 ...D HD W:'PSODLQT&(PSODLECT'>1)&(PSODLERX="TEXT") ! S X=PSODLERB,DIWL=1,DIWR=$S(PSODLERX="MSG":76,1:74) K ^UTILITY($J,"W") D ^DIWP
 ...S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD W:PSODELXF&('PSODLQT) ! D HD W:'PSODLQT $S(PSODLERX="MSG":"   ",1:"     ")_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) D SFD^PSODOSUT
 ...K ^UTILITY($J,"W")
 .D EXCEPT^PSODOSUT
 .D HD W:PSODLERF&('PSODLQT)&('$D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS")))&('$D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE"))) ! S (PSODLERZ,PSODLERF)=0
 .F PSODLERA=0:0 S PSODLERA=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLERA)) Q:'PSODLERA  D
 ..S PSODLERB=$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLERA)) D SBAD^PSODOSUT
 ..Q:PSODLERB=""  D HD I 'PSODLERF W:'PSODLQT !
 ..S PSODLERF=1 D HD S PSODLALZ=1 D HD
 ..S PSOCPXG=$P(PSODLNN1,";",4) I '$G(PSOCPXRR(PSOCPXG)),PSOCPXB>1 D HD W:'PSODLQT&(PSODLERZ) ! D SUB^PSODOSUT
 ..D HD W:'PSODLQT ! N X,DIWL,DIWR,DIWF,DIWL,PSODELXR,PSODELXF S PSODLEXR=1
 ..S DIWL=4,DIWR=76 K ^UTILITY($J,"W")
 ..S X=PSODLERB D ^DIWP D HD I PSODLERB["Range Check Error Summary",PSODLERZ W:'PSODLQT ! D HD
 ..S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD W:PSODELXF&('PSODLQT) ! D HD W:'PSODLQT "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S (PSODELXF,PSODLERZ)=1
 ..K ^UTILITY($J,"W")
 .S PSODLFLG=0 I $$FEED^PSODOSUT D HD W:'PSODLQT !
 .S PSODLPL="" F  S PSODLPL=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE",PSODLPL)) Q:PSODLPL=""  D
 ..F PSODLP1=0:0 S PSODLP1=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE",PSODLPL,PSODLP1)) Q:'PSODLP1  D
 ...S PSODLMSG=$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE",PSODLPL,PSODLP1))
 ...Q:PSODLMSG=""  D HD I 'PSODLFLG W:'PSODLQT !
 ...S PSODLFLG=1 S PSODLEXR=0
 ...I PSODLPL="1_SINGLE" S PSODLINS=1
 ...I PSODLPL="2_RANGE" S PSODLINR=1
 ...;I '$G(PSOCPXF)&($G(PSOCOPY)!($D(PSORENW))) S PSOCPXG=$P(PSODLNN1,";",4) D SUMM^PSODOSUT
 ...S PSOCPXG=$P(PSODLNN1,";",4) D HD D:'$G(PSOCPXRR(PSOCPXG)) SUB^PSODOSUT D
 ....I $G(PSOCPXRR(PSOCPXG))&$P(PSODLNN1,";",5)'="" K PSODAILY
 ....I PSODLPL="2_RANGE",'$G(PSODAILY) D DAILY^PSODOSUT I PSOCPXG'=PSOCPXB K PSODAILY
 ....D HD W:'PSODLQT ! N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF S X=PSODLMSG,DIWL=1,DIWR=76 K ^UTILITY($J,"W") D ^DIWP
 ....S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD W:PSODELXF&('PSODLQT) ! D HD W:'PSODLQT "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S PSODELXF=1
 ....K ^UTILITY($J,"W")
 ....D HD I 'PSODLQT S PSODELNX=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1)) I '$P($G(PSODELNX),";",5)!($P($G(PSODELNX),";",4)'=PSOCPXG) W !
 Q
 ;
DOSEX ;
 S PSODSEQ="" F  S PSODSEQ=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ)) Q:PSODSEQ=""  S PSODLQT=0 S PSODLNN1="" F  S PSODLNN1=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1)) Q:PSODLNN1=""  D:$P(PSODLNN1,";",4)=PSODLXNT
 .F PSODLERA=0:0 S PSODLERA=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"ERROR",PSODLERA)) Q:'PSODLERA  D
 ..F PSODLERX="MSG","TEXT" S PSODLERB=$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"ERROR",PSODLERA,PSODLERX)) D
 ...S PSODLERZ=0 I PSODLERB="" Q
 ...D HD I PSODLERF,PSODLERX="MSG" W:'PSODLQT ! D HD I 'PSODLERF W:'PSODLQT !
 ...S PSODLERF=1 D HD I PSODLERZ W:'PSODLQT !
 ...S PSODLERR=1 D HD W:'PSODLQT ! N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF S X=PSODLERB,DIWL=1,DIWR=$S(PSODLERX="MSG":76,1:74) K ^UTILITY($J,"W") D ^DIWP
 ...S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD W:PSODELXF&('PSODLQT) ! D HD W:'PSODLQT $S(PSODLERX="MSG":"   ",1:"     ")_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) D SFD^PSODOSUT
 ...K ^UTILITY($J,"W")
 .D EXCEPT^PSODOSUT S (PSODLERZ,PSODLERF)=0
 .F PSODLERA=0:0 S PSODLERA=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLERA)) Q:'PSODLERA  D
 ..S PSODLERB=$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLERA)) D SBAD^PSODOSUT:PSODLERB'=""
 ..Q:PSODLERB=""  D HD I 'PSODLERF W:'PSODLQT !
 ..S PSODLERF=1 D HD S PSODLALZ=1 D HD W:'PSODLQT ! N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF S DIWL=1,DIWR=76 K ^UTILITY($J,"W")
 ..S X=PSODLERB D ^DIWP S X=PSODLERB,DIWL=1,DIWR=76 K ^UTILITY($J,"W") D ^DIWP I PSODLERB["Range Check Error Summary",PSODLERZ W:'PSODLQT ! D HD
 ..S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD W:PSODELXF&('PSODLQT) ! D HD W:'PSODLQT "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S (PSODELXF,PSODLERZ)=1
 ..K ^UTILITY($J,"W")
 .S PSODLFLG=0,PSODLPL="" F  S PSODLPL=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE",PSODLPL)) Q:PSODLPL=""  D
 ..F PSODLP1=0:0 S PSODLP1=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE",PSODLPL,PSODLP1)) Q:'PSODLP1  D
 ...S PSODLMSG=$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE",PSODLPL,PSODLP1))
 ...Q:PSODLMSG=""  D HD I 'PSODLFLG W:'PSODLQT !
 ...S PSODLFLG=1 I PSODLPL="1_SINGLE" S PSODLINS=1
 ...I PSODLPL="2_RANGE" S PSODLINR=1 S:PSODLPL="2_RANGE" PSODLINR=1 D
 ...D HD W:'PSODLQT ! N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF S X=PSODLMSG,DIWL=1,DIWR=76 K ^UTILITY($J,"W") D ^DIWP D
 ....S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD W:PSODELXF&('PSODLQT) ! D HD W:'PSODLQT "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S PSODELXF=1
 ....K ^UTILITY($J,"W") D HD I 'PSODLQT S PSODELNX=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1)) I '$P($G(PSODELNX),";",5) W !
 Q
 ;
DOSEZ ;
 S PSODSEQ="" F  S PSODSEQ=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ)) Q:PSODSEQ=""  S PSODLQT=0 K PSOCPXRR S PSODLNN1="" F  S PSODLNN1=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1)) Q:PSODLNN1=""  S PSODLECT=0 D
 .F PSODLERA=0:0 S PSODLERA=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"ERROR",PSODLERA)) Q:'PSODLERA  S PSODLECT=PSODLECT+1 D
 ..F PSODLERX="MSG","TEXT" S PSODLERB=$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"ERROR",PSODLERA,PSODLERX)) D
 ...S PSODLERZ=0 I PSODLERB="" Q
 ...I PSOCPXC D HD I PSODLERF,PSODLERX="MSG" W:'PSODLQT ! D HD
 ...I 'PSODLERF W:'PSODLQT&(PSOCPXC) !
 ...S PSODLERF=1 D:PSOCPXC HD I PSODLERZ W:'PSODLQT&(PSOCPXC) !
 ...S PSODLERR=1 D:PSOCPXC
 ....D HD W:'PSODLQT&(PSODLECT>1) ! N X,DIWL,DIWR,DIWF,PSODELXR,PSODELXF
 ....D:PSOCPXC HD D:'PSOCPXF&(PSOCPXC) SUMM^PSODOSUT
 ....D:PSOCPXC HD S PSOCPXG=$P(PSODLNN1,";",4) I PSOCPXC&('$G(PSOCPXRR(PSOCPXG))) D SUB^PSODOSUT W:'PSODLQT&('PSODLERZ) !
 ....D:PSOCPXC HD W:'PSODLQT&(PSODLECT'>1)&(PSODLERX="TEXT")&(PSOCPXC) ! S X=PSODLERB,DIWL=1,DIWR=$S(PSODLERX="MSG":76,1:74) K ^UTILITY($J,"W") D ^DIWP
 ....S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D:PSOCPXC HD W:PSODELXF&('PSODLQT) ! D:PSOCPXC HD W:'$G(PSODLQT) $S(PSODLERX="MSG":"   ",1:"     ")_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) D SFD^PSODOSUT
 ....K ^UTILITY($J,"W")
 .D EXCEPT^PSODOSUT
 .D:PSOCPXC HD W:PSODLERF&(PSOCPXC)&('PSODLQT)&('$D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS")))&('$D(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE"))) ! S (PSODLERZ,PSODLERF,PSODLESM)=0 ;do i NEED TO INITILIZE THE FIRST TWO
 .F PSODLERA=0:0 S PSODLERA=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLERA)) Q:'PSODLERA  D
 ..S PSODLERB=$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"EXCEPTIONS",PSODLERA)) D SBAD^PSODOSUT:PSODLERB'=""
 ..Q:PSODLERB=""  D:PSOCPXC HD I 'PSODLERF W:'PSODLQT&(PSOCPXC) !
 ..S PSODLERF=1 D:PSOCPXC HD S PSODLALZ=1
 ..D:PSOCPXC
 ...D HD I 'PSOCPXF&(PSOCPXC) D SUMM^PSODOSUT D HD
 ...S PSOCPXG=$P(PSODLNN1,";",4) I PSOCPXC&('$G(PSOCPXRR(PSOCPXG))) D HD W:'PSODLQT&(PSOCPXC)&(PSODLESM) ! D SUB^PSODOSUT
 ...S PSODLESM=1 D HD W:'PSODLQT ! N X,DIWL,DIWR,DIWF,DIWL,PSODELXR,PSODELXF S PSODLEXR=1 S DIWL=1,DIWR=76 K ^UTILITY($J,"W")
 ...S X=PSODLERB D ^DIWP D HD I PSODLERB["Range Check Error Summary",PSODLERZ W:'PSODLQT ! D HD
 ...S X=PSODLERB,DIWL=1,DIWR=76 K ^UTILITY($J,"W") D ^DIWP I PSODLERB["Range Check Error Summary",PSODLERZ W:'PSODLQT ! D HD
 ...S PSODELXF=0 F PSODELXR=0:0 S PSODELXR=$O(^UTILITY($J,"W",DIWL,PSODELXR)) Q:'PSODELXR  D HD W:PSODELXF&('PSODLQT) ! D HD W:'PSODLQT "   "_$G(^UTILITY($J,"W",DIWL,PSODELXR,0)) S (PSODELXF,PSODLERZ)=1
 ...K ^UTILITY($J,"W")
 .S PSODLFLG=0 I $$FEED^PSODOSUT&(PSOCPXC) D HD W:'PSODLQT !
 .S PSODLPL="" F  S PSODLPL=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE",PSODLPL)) Q:PSODLPL=""  D
 ..F PSODLP1=0:0 S PSODLP1=$O(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE",PSODLPL,PSODLP1)) Q:'PSODLP1  D
 ...S PSODLMSG=$G(^TMP($J,"PSOPDOSN","OUT",PSODSEQ,PSODLNN1,"MESSAGE",PSODLPL,PSODLP1))
 ...Q:PSODLMSG=""  D:PSOCPXC HD I 'PSODLFLG W:'PSODLQT&(PSOCPXC)&(PSOCPXF) !
 ...S PSODLFLG=1 S PSODLEXR=0
 ...I PSODLPL="1_SINGLE" S PSODLINS=1
 ...I PSODLPL="2_RANGE" S PSODLINR=1 D
 ....Q:'PSODLQT&(PSOCPXC)&(PSODLESM)  I PSOCPXF&(PSOCPXC) K PSODAILY
 ...D:PSOCPXC HD D COMPLEX^PSODOSUT
 Q
 ;
HD ;
 I PSODLQT!(($Y+5)'>IOSL) Q
 N DIR,DTOUT,DUOUT,DIRUT,DIROUT,X,Y
 W ! K DIR,Y S DIR(0)="E",DIR("A")="Press Return to continue,'^' to exit" D ^DIR K DIR I 'Y S PSODLQT=1 Q
 W @IOF W !
 Q
MESG ;Write out System error heading
 I 'PSODLQT D HD W "Dosing Checks could not be performed:",!
 Q
